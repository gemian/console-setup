#!/usr/bin/make -f

SHELL = /bin/bash
export DH_COMPAT=5

main_build:
	$(MAKE)
	touch main_build

debian/config: debian/config.proto main_build
	awk ' \
/## *FONTSETS *##/ { \
    printf "fontsets='\''"; \
    system("cd Fonts && ls *.psf | sed '\''s/.psf$$//'\''"); \
    printf "'\''"; \
    next; \
} \
/## *CHARMAPS *##/ { \
    printf "charmaps='\''"; \
    system("cd Keyboard && ls acm/*.acm |sed -e '\''s/^acm.//'\'' -e '\''s/.acm$$//'\''"); \
    printf "UTF-8\n"; \
    printf "'\''"; \
    next; \
} \
/## *KBDNAMES *##/ { \
    printf "kbdnames='\''"; \
    system("cd Keyboard && ./kbdnames-maker"); \
    printf "'\''"; \
    next; \
} \
{ \
   print; \
}' debian/config.proto >debian/config

build: main_build debian/config

.PHONY : clean
clean:
	dh_testdir
	-$(MAKE) clean
	-rm -f build main_build
	-rm -f debian/config
	-rm -f debian/*~
	dh_clean

.PHONY : install
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs etc/console-setup 
	dh_install Fonts/*.psf.gz usr/share/consolefonts/
	dh_install Keyboard/acm/*.acm.gz usr/share/consoletrans
	dh_install Keyboard/compose.*.inc etc/console-setup/
	dh_install Keyboard/ckb/ etc/console-setup/
	dh_install Keyboard/ckbcomp usr/bin/
	cp rules debian/console-setup/etc/console-setup/ckb/rules/console
	cp rules.xml debian/console-setup/etc/console-setup/ckb/rules/console.xml
	rm -rf `find debian/console-setup -name .svn`
	dh_installinit --noscripts

# Build architecture-independent files here.
.PHONY : binary-indep
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installxfonts
	dh_installdebconf
	dh_installdocs -A README*
#	dh_installexamples
#	dh_installman
#	dh_installinfo
#	dh_undocumented
	dh_installchangelogs
#	dh_link
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-dependent files here.
.PHONY : binary-arch
binary-arch : build install
# We have nothing to do by default.

.PHONY : binary
binary : binary-indep binary-arch
